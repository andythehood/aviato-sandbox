name: Deploy changed apps ‚Üí Cloud Run (sequential)

on:
  push:
    branches: 
      - "main" 
    paths:
      - "web/**"
  pull_request:
    branches: 
      - "main" 
    paths:
      - "web/**"

env:
  REGION: us-central1
  REPOSITORY: docker

jobs:
  # detect-changes:
  #   name: Get changed apps
  #   runs-on: ubuntu-latest
  #   outputs:
  #     apps: ${{ steps.filter.outputs.changes }}

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Filter changes
  #       uses: dorny/paths-filter@v3
  #       id: filter
  #       with:
  #         filters: |
  #           apps:
  #             - 'web/**'

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.detect.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Detect changed apps
        id: detect
        run: |
          echo "Detecting changed apps..."
          # Compare with the base commit (for PRs) or previous SHA (for push)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE=${{ github.event.pull_request.base.sha }}
          else
            BASE=${{ github.event.before }}
          fi

          CHANGED_PATHS=$(git diff --name-only "$BASE" ${{ github.sha }} | xargs)

          if [ -z "$CHANGED_PATHS" ]; then
            echo "No app changes detected."
            echo "apps=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract unique app directories (e.g. web/core, web/admin)
          APPS=$(echo "$CHANGED_PATHS" | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "Detected apps: $APPS"
          echo "apps=$APPS" >> $GITHUB_OUTPUT
          
  build-and-deploy:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.apps != '[]'  }}
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1  # sequential deploys
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.apps) }}

    env:
      NODE_VERSION: 22
      PNPM_VERSION: 10.20.0
      GCP_PROJECT: ${{ vars.GCP_PROJECT }}
      GCS_BUCKET: ${{ vars.GCS_BUCKET_APPS }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      # - name: üì¶ Setup PNPM (no Corepack)
      #   run: |
      #     npm install -g pnpm@10
      #     pnpm --version

      - name: üìö Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üèóÔ∏è Build React app
        working-directory: web/${{ matrix.app }}
        run: |
          echo "Building app: ${{ matrix.app }}"
          pnpm build

      - name: ‚òÅÔ∏è Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: üß∞ Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}
        #   export_default_credentials: true

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Build and push Docker image
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.REPOSITORY }}/${{ matrix.app }}:${{ github.sha }}
          docker build -t "$IMAGE" -f web/${{ matrix.app }}/Dockerfile .
          docker push "$IMAGE"

      - name: Deploy to Cloud Run
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.REPOSITORY }}/${{ matrix.app }}:${{ github.sha }}

          INGRESS="internal-and-cloud-load-balancing"

          gcloud run deploy "${{ matrix.app }}" \
          --image "$IMAGE" \
          --port 80 \
          --region "${{ env.REGION }}" \
          --platform managed \
          --allow-unauthenticated \
          --ingress $INGRESS \
          --vpc-egress all-traffic \
          --network internal-vpc \
          --subnet internal-vpc

          # Explicitly set IAM policy for public access
          gcloud run services add-iam-policy-binding "${{ matrix.app  }}" \
            --region "${{ env.REGION }}" \
            --member=allUsers \
            --role=roles/run.invoker

            
