name: Deploy changed apps â†’ GCS (sequential)

on:
  push:
    branches: [ "main" ]
    paths:
      - "web/**"
  pull_request:
    branches: [ "main" ]
    paths:
      - "web/**"
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.detect.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect changed apps
        id: detect
        run: |
          echo "Detecting changed apps..."
          # Compare with the base commit (for PRs) or previous SHA (for push)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE=${{ github.event.pull_request.base.sha }}
          else
            BASE=${{ github.event.before }}
          fi

          CHANGED_PATHS=$(git diff --name-only "$BASE" ${{ github.sha }} | xargs)

          if [ -z "$CHANGED_PATHS" ]; then
            echo "No app changes detected."
            echo "apps=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract unique directories
          APPS=$(echo "$CHANGED_PATHS" | tr ' ' '\n' | grep '^web/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "Detected apps: $APPS"
          echo "apps=$APPS" >> $GITHUB_OUTPUT

  build-and-deploy:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.apps != '[]' && needs.detect-changes.outputs.apps != '' }}
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1  # sequential deploys
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.apps) }}

    env:
      NODE_VERSION: 22
      PNPM_VERSION: 10.20.0
      GCP_PROJECT: ${{ vars.GCP_PROJECT }}
      GCS_BUCKET: ${{ vars.GCS_BUCKET_APPS }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      # - name: ğŸ“¦ Setup PNPM (no Corepack)
      #   run: |
      #     npm install -g pnpm@10
      #     pnpm --version

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build React app
        working-directory: web/${{ matrix.app }}
        run: |
          echo "Building app: ${{ matrix.app }}"
          pnpm build

      - name: â˜ï¸ Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ§° Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}
        #   export_default_credentials: true

      - name: ğŸ“¤ Upload build to GCS
        uses: google-github-actions/upload-cloud-storage@v3
        with:
          path: web/${{ matrix.app }}/dist
          destination: ${{ env.GCS_BUCKET }}/${{ matrix.app }}
          parent: false
        #   overwrite: true

      - name: ğŸŒ Invalidate CDN cache for this app
        run: |
          echo "Invalidating CDN cache for /${{ matrix.app }}/*"
          gcloud compute url-maps invalidate-cdn-cache "${{ env.GCS_BUCKET }}-map" \
            --path "/*"

            
